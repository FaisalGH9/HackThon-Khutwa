<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>{{ display_name }} - المحفظة</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body{font-family:'Inter',sans-serif; background:#f9f9fb; margin:0; padding:0;}
    header{display:flex; justify-content:space-between; padding:15px 20px; background:white; box-shadow:0 1px 5px rgba(0,0,0,0.1);}
    .logo{font-size:1.2rem; color:#3a50e0;font-weight:700;}
    .container{background:white; width:90%; max-width:450px; margin:20px auto; padding:20px; border-radius:15px; box-shadow:0 8px 20px rgba(0,0,0,0.1); text-align:center;}
    h1{color:#3a50e0; margin-bottom:10px;}
    .balance-box{border:1px solid #ddd; padding:15px; border-radius:12px; margin-bottom:20px;}
    .balance{font-size:1.2rem; font-weight:700;}
    .spent{font-size:0.95rem; color:#555; margin-top:5px;}
    #chart-container{margin-bottom:20px;}
    form{display:flex; justify-content:center; gap:10px; margin-bottom:15px;}
    input[type=number]{width:120px; padding:8px; border-radius:8px; border:1px solid #ccc; outline-color:#3a50e0;}
    button{background:#3a50e0;color:#fff;padding:8px 16px;border:none;border-radius:8px;cursor:pointer;font-weight:600;}
    .back-link{font-size:0.9rem;color:#3a50e0;text-decoration:none;}
    <style>
    .notification {
    position: fixed;
    top: 80px; right: 20px;
    background: #28a745;
    color: white;
    padding: 10px 15px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    z-index: 1000;
    animation: fadeout 4s forwards;
  }
  @keyframes fadeout {
    0% { opacity: 1; }
    80% { opacity: 1; }
    100% { opacity: 0; transform: translateY(-20px); }
  }
</style>

  </style>
</head>
<body>
  {% with messages = get_flashed_messages() %}
  {% if messages %}
    <div id="notifications">
      {% for msg in messages %}
        <div class="notification">{{ msg }}</div>
      {% endfor %}
    </div>
  {% endif %}
{% endwith %}

  <header><div class="logo">Khutwa</div></header>
  <div class="container">
    <h1>{{ display_name }}</h1>
    <div class="balance-box">
      <div class="balance">الرصيد: ${{ "%.2f"|format(balance) }}</div>
      <div class="spent">ما أنفقه الأسبوع الماضي: ${{ "%.2f"|format(weekly_spent) }}</div>
    </div>

    <div id="chart-container">
      <canvas id="spendingChart"></canvas>
    </div>

    <form method="POST">
      <input type="number" step="0.01" min="0" name="amount" placeholder="أضف مبلغ" required>
      <button type="submit">شحن</button>
    </form>

    {% if display_name == "محمد" %}
      <a href="/missions"
         style="display:block;
                margin:15px auto 5px;
                background:#28a745;
                color:white;
                text-align:center;
                padding:10px 0;
                border-radius:8px;
                width:60%;
                font-weight:600;
                text-decoration:none;">
        الذهاب إلى المهام السلوكية
      </a>
    {% endif %}


    <a href="/" class="back-link">&larr; العودة للرئيسية</a>
  </div>

  <script>
  // Mapping English keys to Arabic
  const arabicMap = {
    "Clothes": "ملابس",
    "Food": "طعام",
    "Internet": "إنترنت",
    "Sport": "رياضة"
  };
  const spending = {{ spending|tojson }};
  const labels = [];
  const data = [];
  for (let key in spending) {
    if (spending.hasOwnProperty(key)) {
      labels.push(arabicMap[key] || key);
      data.push(spending[key]);
    }
  }
  const total = data.reduce((a, b) => a + b, 0);

  new Chart(
    document.getElementById('spendingChart').getContext('2d'),
    {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          data: data,
          backgroundColor: '#3a50e0',
          borderRadius: 6
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: { beginAtZero: true, ticks: { stepSize: 50 } }
        },
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: ctx => `$${ctx.raw} (${((ctx.raw / total) * 100).toFixed(1)}%)`
            }
          },
          datalabels: {
            color: '#000',
            anchor: 'end',
            align: 'top',
            formatter: val => ((val / total) * 100).toFixed(1) + '%'
          }
        }
      },
      plugins: [ChartDataLabels]
    }
  );
</script>

</body>
</html>
